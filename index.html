<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous" />

<h2 id="about">About</h2>

<p>A while ago, I created a <a href="https://github.com/CaptainProton42/DynamicWaterDemo">Dynamic Water Demo</a> in the <a href="https://godotengine.org/">Godot Engine</a>. It showed how to write a realistic water wave simulation entirely within Godot using fragment shaders.</p>

<p>Just recently Nintendo brought a timeless classic, <em>Super Mario Galaxy</em>, to the Switch. I could obvisously not resist the urge to play through it for a fourth time and got back into the game. Not far in, I stumbled upon planets such as this:</p>

<div align="center">
    <img width="75%" src="assets/smg_water_planet.png" /><br />
Image from mariowiki.com
</div>

<p>While these do not exhibit any elaborate water physics, they still inspired me. I wanted to see whether applying the same principles I had already used successfully before would work on a sphere as well as it did on a flat plane. I thus started working on a small scene that would showcase whether something like this was possible using solely built-in Godot functionality (plus some preprocessing in Blender).</p>

<p>I like to think that I succeeded in this mission and in this post I will do what I will call a “scene breakdown”: walk through the process of creating the most important parts of the scene.</p>

<h2 id="recap-dynamic-water-on-a-plane">Recap: Dynamic Water on a Plane</h2>

<p>In my <a href="https://captainproton42.github.io/DynamicWaterDemo/">Dynamic Water Demo</a> I used the <a href="https://en.wikipedia.org/wiki/Finite_difference_method">finite difference method</a> to solve the <a href="https://en.wikipedia.org/wiki/Wave_equation">wave equation</a>. For this, the flat water surface as divided into a rectangular grid. After that, for each time step, the grid points were updated by taking the values of their neighbours (in the previous two time steps) into account.</p>

<div align="center">
    <img width="30%" src="assets/2d_stencil.png" /><br />
Five-point stencil for solving the wave equation in 2 dimensions on a flat surface.
</div>

<p>When applying the water simulation to a sphere, many principles will remain the same or very similar and I will not explain them in detail here. Give the <a href="https://captainproton42.github.io/DynamicWaterDemo/">original demo</a> a read if you are hungry for more details.</p>

<h2 id="discretising-a-sphere">Discretising a Sphere</h2>

<p>If we want to map our simulation to a sphere, we need to choose a different discretisation. We can use meshes for this as they are just discrete representation of 3D shapes. The meshes vertices are then the grid points which are connected by edges. Probably the two most commong ways of meshing (or discretising) spheres are UV spheres and icospheres. If you have ever opened <a href="https://www.blender.org/">Blender</a> or any other 3D modelling software before, you will probably be familier with them:</p>

<div align="center">
    <img width="30%" src="assets/spheres_blender.png" /><br />
Constructing UV or icospheres in blender.
</div>

<p>UV spheres use the same principle as mapping the earth’s surface using lattitude and longitude. You may notice that the UV sphere actually has similar properties to the rectangular grid from above. (Almost) every vertex has four neighbours. But as with earth, all “meridians” converge at the “poles” of the sphere. As a side effect, the distance between points varies depending on how close to the poles one is. For a smooth simulation, however, a more uniform discretisation where each and every vertex has approximately the same distance to its neighbours is desirable.</p>

<div align="center">
    <img width="45%" src="assets/uv_sphere_stencil.png" /><img width="45%" src="assets/ico_sphere_stencil.png" /><br />
Meshes of a UV and an icosphere side-by-side. The neighbourhoods of a single vertex are highlighted.
</div>

<p>An <strong>icosphere</strong> has this property. “Icosphere” is short for “icosahedral sphere” (at least that is what I think). This is because of how an icosphere is constructed: Starting with a regular icosahedron (which is just a fancy word for a three-dimensional shape whose faces are 20 equilateral triangles) we refine each of the faces by triangulating it and projecting the new vertices onto a sphere.</p>

<div align="center">
    <img width="80%" src="assets/geodesic_icosahedral_polyhedron_example.png" /><br />
Construction of an icosphere. The icosahedron's faces are triangulated and then projected onto a sphre. Image from <a href="https://en.wikipedia.org/wiki/File:Geodesic_icosahedral_polyhedron_example.png">Wikipedia</a> (<a href="https://creativecommons.org/licenses/by-sa/4.0/deed.en">CC BY-SA 4.0</a>).
</div>

<p>This results in a sphere where all the vertices are equally spaced, independent of the viewer’s position. Each vertex has six neighbours except for the original vertices of the icosahedron, which retain their count of five neighbours.</p>

<div align="center">
    <img width="45%" src="assets/ico_sphere_5_neighbours.png" /><br />
Original vertices of the icosahedron with only five neighbours.
</div>

<p>In any case, an icosphere has much nicer properties than a UV sphere. The only disadvantage is that we now have a triangular grid where each vertex has five to six neighbours instead of four. This makes things a bit more complicated as we cannot just map the sphere’s surface to a rectangular grid anymore.</p>

<h2 id="simulation-on-an-iscosphere">Simulation on an Iscosphere</h2>

<p>On a rectangular grid, it is very easy to discretise the wave equation directly, resulting the five-point stencil mentioned above. We could also try to do this for a triangular grid but in order to keep things simple, I decided to ignore the wave equation for now and start with a simpler model:</p>

<p>Imagine for a moment that the water surface was made up of single “molecules” that are placed at each vertex of the mesh. Let’s also assume that each molecule is only affected by its direct neighbours (as it was the case on the rectangular grid as well). It now seems intuitive that each molecule’s neighbours “pull” on the molecule, exerting a force that is proportional to their displacement relative to the molecule (thus pulling the molecule upwards if they are higher and pulling it downwards if they are lower). We do not care about more complicated effects that would move the molecules parallel to the surface. We can this vertical displacement easily:</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mfrac><mrow><msup><mi mathvariant="normal">∂</mi><mn>2</mn></msup><mi>z</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>t</mi><mn>2</mn></msup></mrow></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>D</mi><mo>⋅</mo><munder><mo>∑</mo><mrow><mi>k</mi><mo>∈</mo><mi>K</mi></mrow></munder><mrow><mo fence="true">(</mo><msub><mi>z</mi><mi>k</mi></msub><mo>−</mo><mi>z</mi><mo fence="true">)</mo></mrow><mi mathvariant="normal">/</mi><mo stretchy="false">∣</mo><mi>K</mi><mo stretchy="false">∣</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>D</mi><mo>⋅</mo><mrow><mo fence="true">(</mo><munder><mo>∑</mo><mrow><mi>k</mi><mo>∈</mo><mi>K</mi></mrow></munder><msub><mi>z</mi><mi>k</mi></msub><mi mathvariant="normal">/</mi><mo stretchy="false">∣</mo><mi>K</mi><mo stretchy="false">∣</mo><mo>−</mo><mi>z</mi><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\frac{\partial^2z}{\partial t^2} &amp;= D \cdot \sum_{k \in K} \left( z_k - z \right) / \lvert K \rvert \\
&amp;= D \cdot \left( \sum_{k \in K} z_k / \lvert K \rvert - z \right)
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6.500074em;vertical-align:-3.000037em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.500037em;"><span style="top:-5.758929em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.379446em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.000037em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.500037em;"><span style="top:-5.758929em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8478869999999998em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">∈</span><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.329483em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">/</span><span class="mopen">∣</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mclose">∣</span></span></span><span style="top:-2.379446em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8478869999999998em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">∈</span><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.329483em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mopen">∣</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mclose">∣</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.000037em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>

<p>where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span></span></span></span> is the displacement of the vertex (or molecule), <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span> is the (vertex) index set of the neighbouring vertices and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">∣</mo><mi>K</mi><mo stretchy="false">∣</mo></mrow><annotation encoding="application/x-tex">\lvert K \rvert</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">∣</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mclose">∣</span></span></span></span> is the number of neighbours. For the icosphere, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">∣</mo><mi>K</mi><mo stretchy="false">∣</mo></mrow><annotation encoding="application/x-tex">\lvert K \rvert</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">∣</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mclose">∣</span></span></span></span> is either 5 or 6. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span></span></span></span> is an arbitrary constant. The attentive observer will have noticed that the formula above is actually just <a href="https://en.wikipedia.org/wiki/Hooke%27s_law">Hooke’s law</a> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mo>=</mo><mi>D</mi><mo>⋅</mo><mi mathvariant="normal">Δ</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">F = D \cdot \Delta l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">Δ</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span></span></span></span> where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">\Delta l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">Δ</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span></span></span></span> equals the sum in the brackets. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span></span></span></span> can then be interpreted as the spring constant. This means that the choice of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span></span></span></span> will change the behaviour of the water surface.</p>

<p>Normally, we should also account for the distance between neighbouring vertices, but since the vertices are uniformly spaced on the icosphere this is not neccessary here.</p>

<p>There is still one more missing step to arriving at an equation that can be implemented in Godot and that is the discretisation of the time derivative on the left side of the formula (the upper index denotes current step in time):</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right" columnspacing=""><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mfrac><mrow><msup><mi mathvariant="normal">∂</mi><mn>2</mn></msup><mi>z</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>t</mi><mn>2</mn></msup></mrow></mfrac><mo>≈</mo><mfrac><mrow><msup><mi>z</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msup><mo>−</mo><mn>2</mn><mo>⋅</mo><msup><mi>z</mi><mi>t</mi></msup><mo>+</mo><msup><mi>z</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><mrow><mi mathvariant="normal">Δ</mi><msup><mi>t</mi><mn>2</mn></msup></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\frac{\partial^2z}{\partial t^2} \approx \frac{z^{t+1} - 2 \cdot z^t + z^{t-1}}{\Delta t^2}
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4771080000000003em;vertical-align:-0.988554em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4885540000000002em;"><span style="top:-3.488554em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.988554em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>

<p>Inserting this into the original formula, we arrive at</p>

<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mfrac><mrow><msup><mi>z</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msup><mo>−</mo><mn>2</mn><mo>⋅</mo><msup><mi>z</mi><mi>t</mi></msup><mo>+</mo><msup><mi>z</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><mrow><mi mathvariant="normal">Δ</mi><msup><mi>t</mi><mn>2</mn></msup></mrow></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>D</mi><mo>⋅</mo><munder><mo>∑</mo><mrow><mi>k</mi><mo>∈</mo><mi>K</mi></mrow></munder><mrow><mo fence="true">(</mo><msub><mi>z</mi><mi>k</mi></msub><mo>−</mo><mi>z</mi><mo fence="true">)</mo></mrow><mi mathvariant="normal">/</mi><mo stretchy="false">∣</mo><mi>K</mi><mo stretchy="false">∣</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msup><mi>z</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>a</mi><mo>⋅</mo><munder><mo>∑</mo><mrow><mi>k</mi><mo>∈</mo><mi>K</mi></mrow></munder><msubsup><mi>z</mi><mi>k</mi><mi>t</mi></msubsup><mi mathvariant="normal">/</mi><mo stretchy="false">∣</mo><mi>K</mi><mo stretchy="false">∣</mo><mo>+</mo><mo stretchy="false">(</mo><mn>2</mn><mo>−</mo><mi>a</mi><mo stretchy="false">)</mo><mo>⋅</mo><msup><mi>z</mi><mi>t</mi></msup><mo>−</mo><msup><mi>z</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\frac{z^{t+1} - 2 \cdot z^t + z^{t-1}}{\Delta t^2} &amp;= D \cdot \sum_{k \in K} \left( z_k - z \right) / \lvert K \rvert\\
z^{t+1} &amp;= a \cdot \sum_{k \in K} z_k^t / \lvert K \rvert + (2 - a) \cdot z^t - z^{t-1}
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.800079em;vertical-align:-2.6500395em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.1500395em;"><span style="top:-5.1500395em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.4705515em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.6500395em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.1500395em;"><span style="top:-5.1500395em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8478869999999998em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">∈</span><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.329483em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">/</span><span class="mopen">∣</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mclose">∣</span></span></span><span style="top:-2.4705515em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8478869999999998em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">∈</span><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.329483em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8435559999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mopen">∣</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mclose">∣</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.843556em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.6500395em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>

<p>where we define <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>=</mo><mi>D</mi><mo>⋅</mo><mi mathvariant="normal">Δ</mi><msup><mi>t</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">a = D \cdot \Delta t^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">Δ</span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>. Since we will be using Godot’s physics process to update the simulation and Godot’s physics process uses a constant delta time, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">\Delta t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Δ</span><span class="mord mathdefault">t</span></span></span></span> is just a constant which makes this possible.</p>

<p>The fact that this formula is almost identical to the rectangular grid should give us confidence.</p>

<p>To summarize: In order to retreive the updated displacement <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>z</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">z^{t+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span>, we need the current displacements <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>z</mi><mi>k</mi><mi>t</mi></msubsup></mrow><annotation encoding="application/x-tex">z_k^t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0766639999999998em;vertical-align:-0.2831079999999999em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-2.4168920000000003em;margin-left:-0.04398em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831079999999999em;"><span></span></span></span></span></span></span></span></span></span> of all neighbouring vertices, the number of neighbouring vertices <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">∣</mo><mi>K</mi><mo stretchy="false">∣</mo></mrow><annotation encoding="application/x-tex">\lvert K \rvert</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">∣</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mclose">∣</span></span></span></span> as well as the current and previous displacements <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>z</mi><mi>t</mi></msup></mrow><annotation encoding="application/x-tex">z^t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7935559999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>z</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">z^{t-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span>.</p>

<h2 id="implementation">Implementation</h2>

<p>A good way to implement the simulation would be to use compute shaders. We could pass this compute shader the neccessary information for each vertex (number and indices of neighbouring vertices as well as the displacement of each vertex) and then just apply the above formula to every vertex at every time step. Sadly, we are a bit limited, since Godot does not support compute shaders yet. Instead, we will again be using a fragment shader that renders to a separate viewport. We will pass all the neccessary information to the shader via textures. The color of the pixels in the viewport will then be the returned displacement values.</p>

<p>The setup in the editor is actually quite simple: The <code class="language-plaintext highlighter-rouge">ColorRect</code> has a material with the simulation shader assigned. By setting <code class="language-plaintext highlighter-rouge">ColorRect</code> as a child of <code class="language-plaintext highlighter-rouge">SimulationViewport</code>, the output of the shader is then rendered to <code class="language-plaintext highlighter-rouge">SimulationViewport</code>.</p>

<div align="center">
    <img width="25%" src="assets/editor_setup.png" /><br />
</div>

<p>Vertices of a mesh can be numbered using vertex indices. Each vertex index of the icosphere corresponds to a pixel of the <code class="language-plaintext highlighter-rouge">ColorRect</code>: the displacement of the vertex with index <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span> would be rendered to the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>th pixel of the <code class="language-plaintext highlighter-rouge">ColorRect</code>. We only count pixels along one axis, so all textures (input and render output) have dimension of (number of vertices x 1). The resulting textures can then be fed back to the shader after each simulation step to get <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>z</mi><mi>t</mi></msup></mrow><annotation encoding="application/x-tex">z^{t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7935559999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>z</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">z^{t-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span>.</p>

<style>
.infobox {
  background-color: #d4e9fa;
  padding-top: 10px;
  padding-bottom: 10px;
  padding-left: 10px;
  padding-right: 10px;
  border-style: dashed;
  border-color: #4e799c;
  border-radius: 5px;
  margin-top: 5px;
  margin-bottom: 25px;
}

.infobox_title {
  color: #4e799c;
  font-weight: bold;
  white-space: pre;
  padding-bottom: 5px;
}
</style>

<div class="card-panel blue lighten-4">
  <div class="blue-text text-bold text-darken-2" style="padding-bottom: 1em; font-weight: bold">SIZE OF THE VIEWPORT </div>

  <p>When looking at the project files, you may notice that <code class="language-plaintext highlighter-rouge">SimulationViewport</code> has a height of <em>two</em> pixels. Indeed, only <em>one</em> pixel would be enough but I encountered an issue where Godot would not render to a Viewport with a height of only one pixel. I fixed this by adding one pixel to its height.</p>

</div>

<h3 id="preprocessing-in-blender">Preprocessing in Blender</h3>

<p>There are two problems left:</p>

<ol>
  <li>Each vertex of the icosphere needs the correct UVs (coordinates on the textures) assigned.</li>
  <li>We need to pass the neighbours of each vertex to the shader.</li>
</ol>

<p>I solved both of these problems by using a Blender script. The first problem is rather easy to solve: In Blender, all vertices of a mesh have an index available. We already stated that the vertex with index <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span> should correspond to the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>th pixel on the displacement texture. Since UVs only go from 0 to 1, this means that the UV coordinate of each vertex should be <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">v</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><msub><mi mathvariant="normal">x</mi><mi mathvariant="normal">i</mi></msub><mi mathvariant="normal">n</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">x</mi></mrow><mo>+</mo><mn>0.5</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">u</mi><msub><mi mathvariant="normal">m</mi><mi mathvariant="normal">v</mi></msub><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">s</mi></mrow><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">((\mathrm{vertex_index} + 0.5) / \mathrm{num_vertices}, 0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mopen">(</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">v</span><span class="mord mathrm">e</span><span class="mord mathrm">r</span><span class="mord mathrm">t</span><span class="mord mathrm">e</span><span class="mord"><span class="mord mathrm">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31750199999999995em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathrm">n</span><span class="mord mathrm">d</span><span class="mord mathrm">e</span><span class="mord mathrm">x</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mclose">)</span><span class="mord">/</span><span class="mord"><span class="mord mathrm">n</span><span class="mord mathrm">u</span><span class="mord"><span class="mord mathrm">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight" style="margin-right:0.01389em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathrm">e</span><span class="mord mathrm">r</span><span class="mord mathrm">t</span><span class="mord mathrm">i</span><span class="mord mathrm">c</span><span class="mord mathrm">e</span><span class="mord mathrm">s</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span> (we need to add 0.5 to make sure we hit the <em>center</em> of every pixel). In fact, given the index of a vertex (and the total number of vertices), we can retreive its UV coordinates at any time this way.</p>

<p>In Blender, assigning the UVs to the vertices of the icosphere looks somewhat like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">bpy</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">selected_objects</span><span class="p">:</span>
    <span class="n">num_verts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">vertices</span><span class="p">)</span>

    <span class="n">bm</span> <span class="o">=</span> <span class="n">bmesh</span><span class="p">.</span><span class="n">new</span><span class="p">()</span>
    <span class="n">bm</span><span class="p">.</span><span class="n">from_mesh</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">uv_layer</span> <span class="o">=</span> <span class="n">bm</span><span class="p">.</span><span class="n">loops</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">active</span>

    <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">bm</span><span class="p">.</span><span class="n">faces</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">loop</span> <span class="ow">in</span> <span class="n">face</span><span class="p">.</span><span class="n">loops</span><span class="p">:</span>
            <span class="n">vert</span> <span class="o">=</span> <span class="n">loop</span><span class="p">.</span><span class="n">vert</span>
            
            <span class="n">idx</span> <span class="o">=</span> <span class="n">vert</span><span class="p">.</span><span class="n">index</span>
            <span class="n">uv</span> <span class="o">=</span> <span class="p">((</span><span class="n">idx</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_verts</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">loop</span><span class="p">[</span><span class="n">uv_layer</span><span class="p">].</span><span class="n">uv</span> <span class="o">=</span> <span class="n">uv</span>
</code></pre></div></div>

<style>
.infobox {
  background-color: #d4e9fa;
  padding-top: 10px;
  padding-bottom: 10px;
  padding-left: 10px;
  padding-right: 10px;
  border-style: dashed;
  border-color: #4e799c;
  border-radius: 5px;
  margin-top: 5px;
  margin-bottom: 25px;
}

.infobox_title {
  color: #4e799c;
  font-weight: bold;
  white-space: pre;
  padding-bottom: 5px;
}
</style>

<div class="card-panel blue lighten-4">
  <div class="blue-text text-bold text-darken-2" style="padding-bottom: 1em; font-weight: bold">LOOPING THROUGH VERTICES IN BLENDER </div>

  <p>You may have noticed that we are not direclty looping through the vertices in blender. Instead, we are have to loop through the corners of each face by accessing <code class="language-plaintext highlighter-rouge">face.loops</code>. We have to do this in order access mesh attributes such UVs. See also the <a href="https://docs.blender.org/api/current/bmesh.html#customdata-access">Blender documentation</a> on this subject.</p>

</div>

<p>The second problem is a bit more complicated: We already know that each vertex has a maximum of six neighbours. We can thus use six textures to store this information. Let us call these textures <code class="language-plaintext highlighter-rouge">n1</code> to <code class="language-plaintext highlighter-rouge">n6</code>. <code class="language-plaintext highlighter-rouge">n1</code> will contain the vertex indices of the “first” neighbour of each vertex, <code class="language-plaintext highlighter-rouge">n2</code> the the indices of the second and so forth. The way I organized this is illustrated below: Say, for example, the vertex with index 64 has the neighbours with the indices 63, 555, 554, 65, 564, and 561. As a result, the 64th pixel of <code class="language-plaintext highlighter-rouge">n1</code> will contain the index 63, the same pixel of <code class="language-plaintext highlighter-rouge">n2</code> will contain index 555 etc. In case a vertex has only five neighbours, we write a special value to the texture <code class="language-plaintext highlighter-rouge">n6</code> to mark this.</p>

<div align="center">
     <img width="75%" src="assets/neigh_textures.png" /><br />
</div>

<p>It will be important later on that consecutive neighbours share an edge (meaning that <code class="language-plaintext highlighter-rouge">n1</code> and <code class="language-plaintext highlighter-rouge">n2</code> should be connected as should <code class="language-plaintext highlighter-rouge">n2</code> and <code class="language-plaintext highlighter-rouge">n3</code> and so on). Additionally, I saved the vertex positions to a texture since we will also be needing them in the future.</p>

<style>
.infobox {
  background-color: #d4e9fa;
  padding-top: 10px;
  padding-bottom: 10px;
  padding-left: 10px;
  padding-right: 10px;
  border-style: dashed;
  border-color: #4e799c;
  border-radius: 5px;
  margin-top: 5px;
  margin-bottom: 25px;
}

.infobox_title {
  color: #4e799c;
  font-weight: bold;
  white-space: pre;
  padding-bottom: 5px;
}
</style>

<div class="card-panel blue lighten-4">
  <div class="blue-text text-bold text-darken-2" style="padding-bottom: 1em; font-weight: bold">STORING TO TEXTURES </div>

  <p>We could store the indices directly to a single color channel if we were using textures with a high enough bit-depth. While Blender and Godot both support textures with 16 bit or even 32 bit color channels, I ran into some issues using these so I decided to instead use normal PNGs with 8 bit per channel. This meant that instead of storing the indices to a single channel, I had to use multiple channels (giving me a maximum of 32 bits using RGBA). Since the icosphere I used only has 642 vertices, using only the RG channels is enough. The two lower bits of the index are then saved to the G channel and the two higher bits are stored in the R channel.</p>

</div>

<h3 id="the-simulation-shader">The Simulation Shader</h3>

<p>Now that we have created all neccessary textures containing the vertex neighbours, we can write a simulation shader that we assign to the <code class="language-plaintext highlighter-rouge">ColorRect</code>:</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shader_type</span> <span class="n">canvas_item</span><span class="p">;</span>

<span class="k">uniform</span> <span class="kt">float</span> <span class="n">a</span><span class="p">;</span>

<span class="k">uniform</span> <span class="kt">sampler2D</span> <span class="n">z_tex</span><span class="p">;</span>
<span class="k">uniform</span> <span class="kt">sampler2D</span> <span class="n">z_old_tex</span><span class="p">;</span>

<span class="k">uniform</span> <span class="kt">sampler2D</span> <span class="n">n1</span><span class="p">;</span>
<span class="k">uniform</span> <span class="kt">sampler2D</span> <span class="n">n2</span><span class="p">;</span>
<span class="k">uniform</span> <span class="kt">sampler2D</span> <span class="n">n3</span><span class="p">;</span>
<span class="k">uniform</span> <span class="kt">sampler2D</span> <span class="n">n4</span><span class="p">;</span>
<span class="k">uniform</span> <span class="kt">sampler2D</span> <span class="n">n5</span><span class="p">;</span>
<span class="k">uniform</span> <span class="kt">sampler2D</span> <span class="n">n6</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">fragment</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">vec2</span> <span class="n">uv1</span> <span class="o">=</span> <span class="n">getNeighbour</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">UV</span><span class="p">);</span>
    <span class="kt">vec2</span> <span class="n">uv2</span> <span class="o">=</span> <span class="n">getNeighbour</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">UV</span><span class="p">);</span>
    <span class="kt">vec2</span> <span class="n">uv3</span> <span class="o">=</span> <span class="n">getNeighbour</span><span class="p">(</span><span class="n">n3</span><span class="p">,</span> <span class="n">UV</span><span class="p">);</span>
    <span class="kt">vec2</span> <span class="n">uv4</span> <span class="o">=</span> <span class="n">getNeighbour</span><span class="p">(</span><span class="n">n4</span><span class="p">,</span> <span class="n">UV</span><span class="p">);</span>
    <span class="kt">vec2</span> <span class="n">uv5</span> <span class="o">=</span> <span class="n">getNeighbour</span><span class="p">(</span><span class="n">n5</span><span class="p">,</span> <span class="n">UV</span><span class="p">);</span>
    <span class="kt">vec2</span> <span class="n">uv6</span> <span class="o">=</span> <span class="n">getNeighbour</span><span class="p">(</span><span class="n">n6</span><span class="p">,</span> <span class="n">UV</span><span class="p">);</span>
    
    <span class="kt">float</span> <span class="n">num_n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
    <span class="kt">vec2</span> <span class="n">sum_z</span> <span class="o">=</span> <span class="kt">vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">);</span>
    <span class="n">sum_z</span> <span class="o">+=</span> <span class="n">texture</span><span class="p">(</span><span class="n">z_tex</span><span class="p">,</span> <span class="n">uv1</span><span class="p">).</span><span class="n">rg</span><span class="p">;</span>
    <span class="n">sum_z</span> <span class="o">+=</span> <span class="n">texture</span><span class="p">(</span><span class="n">z_tex</span><span class="p">,</span> <span class="n">uv2</span><span class="p">).</span><span class="n">rg</span><span class="p">;</span>
    <span class="n">sum_z</span> <span class="o">+=</span> <span class="n">texture</span><span class="p">(</span><span class="n">z_tex</span><span class="p">,</span> <span class="n">uv3</span><span class="p">).</span><span class="n">rg</span><span class="p">;</span>
    <span class="n">sum_z</span> <span class="o">+=</span> <span class="n">texture</span><span class="p">(</span><span class="n">z_tex</span><span class="p">,</span> <span class="n">uv4</span><span class="p">).</span><span class="n">rg</span><span class="p">;</span>
    <span class="n">sum_z</span> <span class="o">+=</span> <span class="n">texture</span><span class="p">(</span><span class="n">z_tex</span><span class="p">,</span> <span class="n">uv5</span><span class="p">).</span><span class="n">rg</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">uv6</span> <span class="o">!=</span> <span class="kt">vec2</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">sum_z</span> <span class="o">+=</span> <span class="n">texture</span><span class="p">(</span><span class="n">z_tex</span><span class="p">,</span> <span class="n">uv6</span><span class="p">).</span><span class="n">rg</span><span class="p">;</span>
        <span class="n">num_n</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="kt">vec2</span> <span class="n">z</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">z_tex</span><span class="p">,</span> <span class="n">UV</span><span class="p">).</span><span class="n">rg</span><span class="p">;</span>
    <span class="kt">vec2</span> <span class="n">z_old</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">z_old_tex</span><span class="p">,</span> <span class="n">UV</span><span class="p">).</span><span class="n">rg</span><span class="p">;</span>
    
    <span class="n">COLOR</span><span class="p">.</span><span class="n">rg</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">sum_z</span> <span class="o">/</span> <span class="n">num_n</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span> <span class="o">-</span> <span class="n">z_old</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">z_tex</code> and <code class="language-plaintext highlighter-rouge">z_old_tex</code> contain the current and the previous displacements. As before, <code class="language-plaintext highlighter-rouge">n1</code> through <code class="language-plaintext highlighter-rouge">n6</code> are one-dimensional textures which contain the indices of all the vertex neighbours. The function <code class="language-plaintext highlighter-rouge">getNeighbour</code> reads these indices from the corresponding textures and then calculates and returns the UVs or <code class="language-plaintext highlighter-rouge">vec2(-1.0f)</code> if the neighbour does not exist.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">uniform</span> <span class="kt">float</span> <span class="n">num_vertices</span> <span class="o">=</span> <span class="mi">642</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>

<span class="kt">vec2</span> <span class="nf">getNeighbour</span><span class="p">(</span><span class="kt">sampler2D</span> <span class="n">n</span><span class="p">,</span> <span class="kt">vec2</span> <span class="n">uv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">vec4</span> <span class="n">c</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">uv</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">vec2</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/* idx = (c.r * 255) &lt;&lt; 8 + (c.g * 255) */</span>
    <span class="kt">float</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">r</span> <span class="o">*</span> <span class="mi">65280</span><span class="n">f</span> <span class="o">+</span> <span class="n">c</span><span class="p">.</span><span class="n">g</span> <span class="o">*</span> <span class="mi">255</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="kt">vec2</span><span class="p">((</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_vertices</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We then sum the displacements of all neighbours and calculate the new displacement using the formula from above. The new displacements are then rendered to the <code class="language-plaintext highlighter-rouge">SimulationViewport</code>. Notice that we are using both red and the green channel in our simulation. The red channel is used to store positive waves while the green channel stores negative waves. We can later just subtract the green channel from the red channel to retrieve the final displacement.</p>

<p>We also have to add a script to <code class="language-plaintext highlighter-rouge">SimulationViewport</code> that updates the simulation each physics frame by swapping textures and rendering a single frame to the Viewport:</p>

<div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="nf">_update_map</span><span class="p">():</span>
    <span class="k">var</span> <span class="n">img</span> <span class="o">=</span> <span class="n">get_texture</span><span class="p">()</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
    <span class="n">simulation_material</span><span class="o">.</span><span class="n">get_shader_param</span><span class="p">(</span><span class="s2">"z_old_tex"</span><span class="p">)</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">simulation_material</span><span class="o">.</span><span class="n">get_shader_param</span><span class="p">(</span><span class="s2">"z_tex"</span><span class="p">)</span><span class="o">.</span><span class="n">get_data</span><span class="p">())</span>
    <span class="n">simulation_material</span><span class="o">.</span><span class="n">get_shader_param</span><span class="p">(</span><span class="s2">"z_tex"</span><span class="p">)</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<span class="k">func</span> <span class="nf">_update</span><span class="p">():</span>
    <span class="n">_update_map</span><span class="p">()</span>
    <span class="n">render_target_update_mode</span> <span class="o">=</span> <span class="n">UPDATE_ONCE</span>
    <span class="nb">yield</span><span class="p">(</span><span class="n">get_tree</span><span class="p">(),</span> <span class="s2">"idle_frame"</span><span class="p">)</span>

<span class="k">func</span> <span class="nf">_physics_process</span><span class="p">(</span><span class="n">_delta</span><span class="p">):</span>
    <span class="n">_update</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="displaying-the-simulation-on-the-icosphere">Displaying the Simulation on the Icosphere</h3>

<p>We now have the simulation running but it is not displaying yet. In order to make that happen, we need to export the icosphere with the correct UVs from Blender and add it to the scene in Godot as a <code class="language-plaintext highlighter-rouge">MeshInstance</code>. Remember, each vertex UV corresponds to a pixel on the displacement texture from <code class="language-plaintext highlighter-rouge">SimulationViewport</code>.</p>

<p>We can thus write a simple shader that retrieves the displacement of each vertex and moves it outwards or inwards depending on the displacement value.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>

<span class="k">uniform</span> <span class="kt">sampler2D</span> <span class="n">vertex_position_tex</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">vertex</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">VERTEX</span> <span class="o">+=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">)</span> <span class="o">*</span> <span class="n">getDisplacement</span><span class="p">(</span><span class="n">UV</span><span class="p">);</span>
    <span class="n">NORMAL</span> <span class="o">=</span> <span class="n">calculateVertexNormal</span><span class="p">(</span><span class="n">UV</span><span class="p">,</span> <span class="n">VERTEX</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Add fragment and lighting effects in the fragment() or light() functions.</span>
</code></pre></div></div>

<p>A stated before, we subtract the green channel from the red channel to get the final displacement:</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">uniform</span> <span class="kt">sampler2D</span> <span class="n">z_tex</span><span class="p">;</span>

<span class="kt">float</span> <span class="nf">getDisplacement</span><span class="p">(</span><span class="kt">vec2</span> <span class="n">uv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">vec4</span> <span class="n">c</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">z_tex</span><span class="p">,</span> <span class="n">uv</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">.</span><span class="n">r</span> <span class="o">-</span> <span class="n">c</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And this is it! The sphere will now be deformed by the simulation.</p>

<style>
.infobox {
  background-color: #d4e9fa;
  padding-top: 10px;
  padding-bottom: 10px;
  padding-left: 10px;
  padding-right: 10px;
  border-style: dashed;
  border-color: #4e799c;
  border-radius: 5px;
  margin-top: 5px;
  margin-bottom: 25px;
}

.infobox_title {
  color: #4e799c;
  font-weight: bold;
  white-space: pre;
  padding-bottom: 5px;
}
</style>

<div class="card-panel blue lighten-4">
  <div class="blue-text text-bold text-darken-2" style="padding-bottom: 1em; font-weight: bold">CALCULATING VERTEX NORMALS </div>

  <p>If order to achieve convincing lighting effects we also need to update the normals of each vertex.</p>

  <p>For this, we need to know that the normal of a vertex is a weighted sum of the normals of all adjacent faces:</p>

  <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right" columnspacing=""><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mover accent="true"><mi>N</mi><mo>⃗</mo></mover><mrow><mi mathvariant="normal">v</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">t</mi></mrow></msub><mo>=</mo><mo>∑</mo><mi>w</mi><mo>⋅</mo><msub><mover accent="true"><mi>N</mi><mo>⃗</mo></mover><mrow><mi mathvariant="normal">f</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">e</mi></mrow></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\vec{N}_\mathrm{vert} = \sum w \cdot \vec{N}_\mathrm{face}
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.90001em;vertical-align:-0.7000050000000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.200005em;"><span style="top:-3.200005em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight" style="margin-right:0.01389em;">v</span><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight">r</span><span class="mord mathrm mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop op-symbol large-op" style="position:relative;top:-0.000004999999999977245em;">∑</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7000050000000001em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>

  <p>Calculating the face normals then is quite easy: The cross product, if you are not already familiar with it, of two vectors will produce a third vector that is perpendicular to both vectors and whose length is equal to the parallelogram they define.</p>

  <div align="center">
    <img width="25%" src="assets/cross_product.png" /><br />
Image from <a href="https://commons.wikimedia.org/wiki/File:Cross_parallelogram.png">Wikipedia</a>.
</div>

  <p>We can thus calculate a face normal that is weighted by the area of the face by taking the cross product of two edges of the face. Say <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>v</mi><mo>⃗</mo></mover><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\vec{v}_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.864em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.20772em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>v</mi><mo>⃗</mo></mover><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\vec{v}_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.864em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.20772em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>v</mi><mo>⃗</mo></mover><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\vec{v}_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.864em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.20772em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> are the three vertices of a face. We can then write:</p>

  <p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right" columnspacing=""><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>w</mi><mo>⋅</mo><msub><mover accent="true"><mi>N</mi><mo>⃗</mo></mover><mrow><mi mathvariant="normal">f</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">e</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">(</mo><msub><mover accent="true"><mi>v</mi><mo>⃗</mo></mover><mn>1</mn></msub><mo>−</mo><msub><mover accent="true"><mi>v</mi><mo>⃗</mo></mover><mn>0</mn></msub><mo fence="true">)</mo></mrow><mo>×</mo><mrow><mo fence="true">(</mo><msub><mover accent="true"><mi>v</mi><mo>⃗</mo></mover><mn>2</mn></msub><mo>−</mo><msub><mover accent="true"><mi>v</mi><mo>⃗</mo></mover><mn>0</mn></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
w \cdot \vec{N}_\mathrm{face} = \left( \vec{v}_1 - \vec{v}_0 \right) \times \left( \vec{v}_2 - \vec{v}_0 \right)
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.62633em;vertical-align:-0.5631649999999999em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0631650000000001em;"><span style="top:-3.0968350000000004em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9663299999999999em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.25233em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.15216em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight" style="margin-right:0.07778em;">f</span><span class="mord mathrm mtight">a</span><span class="mord mathrm mtight">c</span><span class="mord mathrm mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.20772em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.20772em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.20772em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.20772em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5 3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11 10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63 -1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1 -7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59 H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359 c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5631649999999999em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>

  <p>So to calculate a vertex normal we need the positions of all neighbouring vertices. We then calculate each weighted face normal using two connected neighbours, add all of them up and normalize the result.</p>

  <p>The final shader code to calculate the vertex normals looks like this:</p>

  <div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">vec3</span> <span class="nf">calculateVertexNormal</span><span class="p">(</span><span class="kt">vec2</span> <span class="n">uv</span><span class="p">,</span> <span class="kt">vec3</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">vec2</span> <span class="n">uv1</span> <span class="o">=</span> <span class="n">getNeighbour</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">uv</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="kt">vec2</span> <span class="n">uv6</span> <span class="o">=</span> <span class="n">getNeighbour</span><span class="p">(</span><span class="n">n6</span><span class="p">,</span> <span class="n">uv</span><span class="p">);</span>
    
    <span class="kt">vec3</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">getPos</span><span class="p">(</span><span class="n">uv1</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="kt">vec3</span> <span class="n">p5</span> <span class="o">=</span> <span class="n">getPos</span><span class="p">(</span><span class="n">uv5</span><span class="p">);</span>
    
    <span class="kt">vec3</span> <span class="n">q1</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">normalize</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">*</span> <span class="n">getDisplacement</span><span class="p">(</span><span class="n">uv1</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="kt">vec3</span> <span class="n">q5</span> <span class="o">=</span> <span class="n">p5</span> <span class="o">+</span> <span class="n">normalize</span><span class="p">(</span><span class="n">p5</span><span class="p">)</span> <span class="o">*</span> <span class="n">getDisplacement</span><span class="p">(</span><span class="n">uv5</span><span class="p">);</span>

    <span class="kt">vec3</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">calculateFaceNormal</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="kt">vec3</span> <span class="n">f4</span> <span class="o">=</span> <span class="n">calculateFaceNormal</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">q4</span><span class="p">,</span> <span class="n">q5</span><span class="p">);</span>
    <span class="kt">vec3</span> <span class="n">f5</span> <span class="o">=</span> <span class="kt">vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">);</span>
    <span class="kt">vec3</span> <span class="n">f6</span> <span class="o">=</span> <span class="kt">vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uv6</span> <span class="o">==</span> <span class="kt">vec2</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// vertex has 5 neighbours</span>
        <span class="n">f5</span> <span class="o">=</span> <span class="n">calculateFaceNormal</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">q5</span><span class="p">,</span> <span class="n">q1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// vertex has 6 neighbours</span>
        <span class="kt">vec3</span> <span class="n">p6</span> <span class="o">=</span> <span class="n">getPos</span><span class="p">(</span><span class="n">uv6</span><span class="p">);</span>
        <span class="kt">vec3</span> <span class="n">q6</span> <span class="o">=</span> <span class="n">p6</span> <span class="o">+</span> <span class="n">normalize</span><span class="p">(</span><span class="n">p6</span><span class="p">)</span> <span class="o">*</span> <span class="n">getDisplacement</span><span class="p">(</span><span class="n">uv6</span><span class="p">);</span>
        <span class="n">f5</span> <span class="o">=</span> <span class="n">calculateFaceNormal</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">q5</span><span class="p">,</span> <span class="n">q6</span><span class="p">);</span>
        <span class="n">f6</span> <span class="o">=</span> <span class="n">calculateFaceNormal</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">q6</span><span class="p">,</span> <span class="n">q1</span><span class="p">);</span>	
    <span class="p">}</span>
    
    <span class="kt">vec3</span> <span class="n">n</span> <span class="o">=</span> <span class="kt">vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">);</span>
    
    <span class="n">n</span> <span class="o">+=</span> <span class="n">f1</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="n">n</span> <span class="o">+=</span> <span class="n">f6</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="n">normalize</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>  </div>

  <p>where <code class="language-plaintext highlighter-rouge">getPos</code> retreives the vertex position of the corresponding neighbour</p>

  <div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">uniform</span> <span class="kt">sampler2D</span> <span class="n">vertex_position_tex</span><span class="p">;</span>

<span class="kt">vec3</span> <span class="nf">getPos</span><span class="p">(</span><span class="kt">vec2</span> <span class="n">uv</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">vertex_position_tex</span><span class="p">,</span> <span class="n">uv</span><span class="p">).</span><span class="n">xyz</span> <span class="o">*</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>  </div>

  <p>and <code class="language-plaintext highlighter-rouge">calculateFaceNormal</code> calculates the weighted normal of each face.</p>

  <div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">vec3</span> <span class="nf">calculateFaceNormal</span><span class="p">(</span><span class="kt">vec3</span> <span class="n">a</span><span class="p">,</span> <span class="kt">vec3</span> <span class="n">b</span><span class="p">,</span> <span class="kt">vec3</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">vec3</span> <span class="n">n</span> <span class="o">=</span> <span class="n">cross</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span> <span class="o">-</span> <span class="n">a</span><span class="p">);</span>
    <span class="kt">vec3</span> <span class="n">v</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="n">n</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>  </div>

  <p>We can now see why it was important to sort the neighbours earlier: If <code class="language-plaintext highlighter-rouge">n2</code> was not a neighbour of <code class="language-plaintext highlighter-rouge">n1</code>, the resulting normal would not correspond to an actual face.</p>

  <p>The correct normals an now be used inside the <code class="language-plaintext highlighter-rouge">fragment()</code> and <code class="language-plaintext highlighter-rouge">light()</code> processors to create convincing effects.</p>

</div>

<h3 id="player-interaction">Player Interaction</h3>

<p>You may have the feeling that we are missing one final part of the puzzle and by doing to you are quite correct. We have implemented the simulation as well as displaying it on a sphere. And while the ability to propagate waves across the sphere’s surface is nice, it is pretty useless without the ability to actually <em>create</em> waves. So I will briefly explain how interaction with the simulation could work:</p>

<p>I decided that the player should have the ability to create waves by clicking at any point on the sphere. Thus, detecting where on the sphere the mouse is, is the first step. In Godot, this can be easily done by adding a spherical <code class="language-plaintext highlighter-rouge">CollisionShape</code> to an <code class="language-plaintext highlighter-rouge">Area</code>. I can then use the <code class="language-plaintext highlighter-rouge">Area</code>s <code class="language-plaintext highlighter-rouge">input_event</code> to retrieve and store the position of the mouse click. I can then create waves directly in the fragment shader by manually setting displacement values based on the distance to the click position.</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">uniform</span> <span class="kt">vec4</span> <span class="n">click_position</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">fragment</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">...</span>
	<span class="kt">float</span> <span class="n">click_dist</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">click_position</span><span class="p">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="n">getPos</span><span class="p">(</span><span class="n">UV</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">click_dist</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">15</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">click_position</span><span class="p">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">COLOR</span><span class="p">.</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">15</span><span class="n">f</span> <span class="o">-</span> <span class="n">click_dist</span><span class="p">)</span> <span class="o">/</span> <span class="mi">0</span><span class="p">.</span><span class="mi">15</span><span class="n">f</span> <span class="o">*</span> <span class="n">click_position</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">COLOR</span><span class="p">.</span><span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">15</span><span class="n">f</span> <span class="o">-</span> <span class="n">click_dist</span><span class="p">)</span> <span class="o">/</span> <span class="mi">0</span><span class="p">.</span><span class="mi">15</span><span class="n">f</span> <span class="o">*</span> <span class="o">-</span><span class="n">click_position</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>By additionally setting the alpha value of the <code class="language-plaintext highlighter-rouge">click_position</code> uniform I can  decide whether to create positive or negative waves. In order to conserve the volume of the sphere, it is a good idea to create first a positive wave and then shortly thereafter a negative wave for a single click, as only creating positive or negative waves would “bloat” or “shrink” the sphere.</p>

<h3 id="bonus-boids">Bonus: Boids</h3>

<p>In order to fill the aquarium with some life, I decided to add schools of fish, often also called boids. My boid implementation is a pretty direct Godot translation of <a href="https://github.com/SebLague/Boids">Sebastian Lague</a>’s Unity implementation. If you want to know more about the theory behind boinds, check out his <a href="https://www.youtube.com/watch?v=bqtqltqcQhw&amp;list=PLWgxw5OT1k36u9vSvt7_MD_yTPdB07-QR&amp;index=19">Coding Adventure</a> video on the topic, it is a pretty interesting watch.</p>

<h3 id="thoughts-and-conclusion">Thoughts and Conclusion</h3>

<p>Although the scene turned out very nice, I still noticed some issues with the approach, mainly due to its relative simplicity. Besides some minor visual artifacts, the simulation is not very stable when trying to create slower moving waves. I could solve this by using an icosphere with more vertices but in that case the waves dissipate very quickyly. This is related to the simulation only taking into account direct neighbours and two previous timesteps. A more sophisticated method could (possibly at more computational cost) create a more stable, precise simulation.</p>

<p>I still hope you found this to be an interesting read. Please tell me on Twitter(<a href="https://twitter.com/CaptainProton42">@CaptainProton42</a>) and Reddit (<a href="https://www.reddit.com/user/captainproton42">/u/CaptainProton42</a>).</p>

